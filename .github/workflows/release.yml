name: Release Mod

on:
    push:
        tags:
            - "v*"

permissions:
    contents: write

jobs:
    build:
        strategy:
            fail-fast: false

            matrix:
                config:
                    - name: Windows
                      os: windows-latest
                      build-type: RelWithDebInfo

                    - name: macOS
                      os: macos-latest

                    - name: iOS
                      os: macos-latest
                      target: iOS

                    - name: Android32
                      os: ubuntu-latest
                      target: Android32

                    - name: Android64
                      os: ubuntu-latest
                      target: Android64

        name: ${{ matrix.config.name }}
        runs-on: ${{ matrix.config.os }}

        steps:
            - uses: actions/checkout@v4

            - name: Build the mod
              uses: geode-sdk/build-geode-mod@main
              with:
                  combine: true
                  export-pdb: true
                  target: ${{ matrix.config.target }}
                  build-config: ${{ matrix.config.build-type || 'Release'}}

    package:
        name: Package Builds
        runs-on: ubuntu-latest
        needs: ["build"]

        steps:
            - uses: geode-sdk/build-geode-mod/combine@main
              id: build

            - uses: actions/upload-artifact@v4
              with:
                  name: Build Output
                  path: ${{ steps.build.outputs.build-output }}

    release:
        name: Release
        runs-on: ubuntu-latest
        needs: ["package"]

        steps:
            - uses: actions/download-artifact@v4
              with:
                  path: ./artifacts/

            - name: Extract changelog section
              id: changelog
              run: |
                  TAG=${GITHUB_REF_NAME}
                  BODY=$(awk -v tag="${TAG}" '$0=="# " tag{found=1; next} found && /^# /{exit} found{print}' changelog.md || true)
                  if [ -z "$BODY" ]; then
                      BODY="Release for commit ${GITHUB_SHA}."
                  fi
                  echo "body<<EOF" >> $GITHUB_OUTPUT
                  printf "%s\n" "$BODY" >> $GITHUB_OUTPUT
                  echo "EOF" >> $GITHUB_OUTPUT

            - name: Publish Release
              uses: softprops/action-gh-release@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  tag_name: ${{ github.ref_name }}
                  name: "Release ${{ github.ref_name }}"
                  body: ${{ steps.changelog.outputs.body }}
                  prerelease: false
                  files: |
                      ./artifacts/Build Output/*.geode
                      ./artifacts/Build Output/*.pdb

            - name: Publish to Geode
              uses: hiimjasmine00/release-geode-mod/publish@main
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Check for Discord webhook URL
              id: check
              run: echo "has-nightly-webhook=${{ secrets.NIGHTLY_WEBHOOK != '' }}" >> $GITHUB_OUTPUT

            - name: Send Discord webhook
              if: ${{ steps.check.outputs.has-nightly-webhook == 'true' }}
              uses: prevter/discord-webhook@main
              with:
                  webhook-url: ${{ secrets.NIGHTLY_WEBHOOK }}
                  files: |
                      ./artifacts/Build Output/*.geode
                      ./artifacts/Build Output/*.pdb
                  embed-title: "[${{ github.repository }}] Release ${{ github.ref_name }}"
                  embed-description: "Release for commit **[`${{ github.sha }}`](${{ github.event.repository.html_url}}/commit/${{ github.sha }})**."
                  embed-color: "#3fb950"
                  embed-url: ${{ github.event.repository.html_url }}/releases/tag/${{ github.ref_name }}
                  embed-author: ${{ github.actor }}
                  embed-author-icon: "https://avatars.githubusercontent.com/u/${{ github.actor_id }}?v=4"
                  embed-thumbnail: "https://raw.githubusercontent.com/${{ github.repository }}/refs/heads/${{ github.event.repository.default_branch }}/logo.png"
                  embed-timestamp: "now"
